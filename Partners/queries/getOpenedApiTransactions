SELECT
    [APIID],
    [localState],
    [APILitre],
    a.[VCode] as 'apiVCode',
    t.VCode as 'transVCode',
    a.[DateOpen],
    a.[DateClose]
FROM [agzs].[dbo].[PR_APITransaction] a
INNER JOIN [agzs].[dbo].[ADAST_TRKTransaction] t
    ON (a.Link = t.vcode)
WHERE ((SELECT count(*)
        FROM agzs.dbo.ARM_PayOperation p
        WHERE p.Link = t.VCode) = 0)
    and t.iPayWay = %1
    and localState <> 'Ошибка: 30 минут'
    and localState <> 'Отменена'
    and localState <> 'Ошибка: Кассир отменил'
    and localState <> 'Ошибка: 30 минут, кассир отменил'

    and t.agzs = (  SELECT TOP 1
                        AGZS
                    FROM [agzs].[dbo].[Identification])
ORDER BY DateOpen desc
